# Swift Package Manager Guide

## Table of Contents

- [Overview](#overview)
- [Package.swift Configuration](#packageswift-configuration)
- [Dependency Management](#dependency-management)
- [Xcode Integration](#xcode-integration)
- [Local Development](#local-development)
- [CI/CD Integration](#cicd-integration)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)

## Overview

This project uses Swift Package Manager (SPM) for dependency management across iOS, macOS, and Mac Catalyst platforms. This guide covers how to manage dependencies, configure packages, and integrate with development workflows.

### Supported Platforms

- **iOS**: 15.0 and later
- **macOS**: 12.0 and later
- **Mac Catalyst**: 15.0 and later

## Package.swift Configuration

### Basic Structure

The `Package.swift` file defines:
- Package metadata and platforms
- Products (libraries/executables)
- Dependencies and their versions
- Targets and their relationships
- Build settings and configurations

### Adding Dependencies

#### 1. Networking Libraries
```swift
dependencies: [
    .package(url: "https://github.com/Alamofire/Alamofire.git", from: "5.8.0"),
]
```

#### 2. UI/SwiftUI Extensions
```swift
dependencies: [
    .package(url: "https://github.com/SwiftUIX/SwiftUIX.git", from: "0.1.0"),
]
```

#### 3. Utility Libraries
```swift
dependencies: [
    .package(url: "https://github.com/apple/swift-algorithms.git", from: "1.0.0"),
    .package(url: "https://github.com/apple/swift-collections.git", from: "1.0.0"),
]
```

#### 4. Testing Dependencies
```swift
dependencies: [
    .package(url: "https://github.com/pointfreeco/swift-snapshot-testing.git", from: "1.12.0"),
]
```

### Version Specification

#### Semantic Versioning
```swift
// Exact version
.package(url: "...", .exact("1.2.3"))

// From version (allows compatible updates)
.package(url: "...", from: "1.2.0")

// Version range
.package(url: "...", "1.0.0"..<"2.0.0")

// Branch (for development)
.package(url: "...", branch: "main")

// Revision (specific commit)
.package(url: "...", revision: "abc123")
```

## Dependency Management

### Adding New Dependencies

1. **Edit Package.swift**
   ```bash
   # Open in your editor
   open Package.swift
   ```

2. **Add dependency to dependencies array**
   ```swift
   dependencies: [
       .package(url: "https://github.com/owner/repo.git", from: "1.0.0"),
   ]
   ```

3. **Add to target dependencies**
   ```swift
   .target(
       name: "TemplateProject",
       dependencies: [
           .product(name: "ProductName", package: "repo"),
       ]
   )
   ```

4. **Update package resolution**
   ```bash
   swift package update
   ```

### Removing Dependencies

1. Remove from `dependencies` array in Package.swift
2. Remove from target `dependencies`
3. Remove import statements from source code
4. Update package resolution:
   ```bash
   swift package update
   ```

### Updating Dependencies

#### Update All Dependencies
```bash
swift package update
```

#### Update Specific Dependency
```bash
swift package update <package-name>
```

#### Show Outdated Dependencies
```bash
swift package show-dependencies --format json | jq '.dependencies[]'
```

### Pin Specific Versions

Use `Package.resolved` to lock specific versions:
```bash
# This file is automatically generated and should be committed
git add Package.resolved
git commit -m "Lock dependency versions"
```

## Xcode Integration

### Opening Project in Xcode

#### For Package Projects
```bash
open Package.swift
# or
xed .
```

#### For Xcode Projects with SPM
1. Open your `.xcodeproj` or `.xcworkspace`
2. Go to File â†’ Add Package Dependencies
3. Enter the package URL
4. Select version requirements
5. Choose target to add the package to

### Xcode Configuration

#### Build Settings
- Xcode automatically configures build settings for SPM
- Custom settings can be added in Package.swift

#### Scheme Configuration
- Xcode creates schemes for each target automatically
- Custom schemes can be shared via `.swiftpm/xcode/xcshareddata/`

#### Debugging Packages
1. Enable "My Mac (Designed for iPad)" destination
2. Use breakpoints in package source
3. Step through package code during debugging

## Local Development

### Local Package Development

#### 1. Clone Package Locally
```bash
git clone https://github.com/owner/package.git
cd package
```

#### 2. Edit Package.swift
```swift
dependencies: [
    .package(path: "../local-package-path"),
]
```

#### 3. Development Workflow
```bash
# Make changes to local package
# Test changes
swift test

# Build project with local changes
swift build
```

### Creating Local Packages

#### 1. Initialize New Package
```bash
swift package init --type library --name MyPackage
cd MyPackage
```

#### 2. Package Structure
```
MyPackage/
â”œâ”€â”€ Package.swift
â”œâ”€â”€ README.md
â”œâ”€â”€ Sources/
â”‚   â””â”€â”€ MyPackage/
â”‚       â””â”€â”€ MyPackage.swift
â””â”€â”€ Tests/
    â””â”€â”€ MyPackageTests/
        â””â”€â”€ MyPackageTests.swift
```

### Package Resolution

#### Clear Package Cache
```bash
rm -rf .build
swift package clean
swift package reset
```

#### Resolve Dependencies
```bash
swift package resolve
```

#### Show Dependencies
```bash
swift package show-dependencies
swift package show-dependencies --format json
```

## CI/CD Integration

### GitHub Actions Configuration

#### Package Resolution Caching
```yaml
- name: Cache Swift Package Manager
  uses: actions/cache@v3
  with:
    path: |
      .build
      SourcePackages
    key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
    restore-keys: |
      ${{ runner.os }}-spm-
```

#### Build and Test
```yaml
- name: Build and Test
  run: |
    swift build --configuration release
    swift test --configuration release
```

#### Platform Matrix
```yaml
strategy:
  matrix:
    os: [macos-latest]
    xcode: ['15.2', '15.1']
runs-on: ${{ matrix.os }}
steps:
  - uses: maxim-lobanov/setup-xcode@v1
    with:
      xcode-version: ${{ matrix.xcode }}
```

### Fastlane Integration

#### Package Management Lane
```ruby
lane :validate_packages do
  sh("swift package resolve")
  sh("swift build --configuration release")
  sh("swift test --configuration release")
end
```

## Best Practices

### Dependency Selection

#### 1. Evaluation Criteria
- **Active maintenance**: Regular updates and issue responses
- **Community support**: Stars, forks, contributors
- **Documentation quality**: Clear README and API docs
- **Testing coverage**: Comprehensive test suite
- **Platform support**: iOS/macOS compatibility
- **License compatibility**: MIT, Apache 2.0, BSD preferred

#### 2. Preferred Dependencies
- **Apple First**: Prefer Apple's packages when available
- **Well-established**: Choose mature, widely-used packages
- **Minimal footprint**: Avoid packages with heavy dependencies
- **Swift-native**: Prefer Swift over Objective-C bridges

### Version Management

#### 1. Semantic Versioning
- Use `from:` for most dependencies
- Use exact versions only when necessary
- Avoid branch dependencies in production

#### 2. Version Pinning
- Commit `Package.resolved` for reproducible builds
- Review and update dependencies regularly
- Test thoroughly after updates

### Package Organization

#### 1. Target Structure
```swift
// Separate concerns into focused targets
.target(name: "Core", dependencies: []),
.target(name: "UI", dependencies: ["Core"]),
.target(name: "Networking", dependencies: ["Core"]),
```

#### 2. Platform-Specific Code
```swift
// Use conditional compilation
#if os(iOS)
import UIKit
#elseif os(macOS)
import AppKit
#endif
```

### Security Practices

#### 1. Dependency Auditing
- Review all dependencies before adding
- Monitor for security vulnerabilities
- Use GitHub Security Advisories
- Regular dependency updates

#### 2. Source Verification
- Use HTTPS URLs for all packages
- Verify package checksums when possible
- Review package source code for critical dependencies

## Troubleshooting

### Common Issues

#### 1. Package Resolution Failures
```bash
# Clear cache and retry
rm -rf .build SourcePackages
swift package clean
swift package resolve
```

#### 2. Version Conflicts
```bash
# Show dependency tree
swift package show-dependencies

# Update to latest compatible versions
swift package update
```

#### 3. Build Failures
```bash
# Clean build folder
swift package clean

# Rebuild with verbose output
swift build --verbose
```

#### 4. Xcode Integration Issues
- Close Xcode
- Delete derived data: `rm -rf ~/Library/Developer/Xcode/DerivedData`
- Clean SPM cache: `rm -rf ~/Library/Caches/org.swift.swiftpm`
- Reopen project

### Performance Optimization

#### 1. Build Performance
- Use `.build` folder caching in CI
- Minimize dependencies
- Use binary packages for large dependencies
- Enable parallel builds

#### 2. Resolution Performance
- Commit `Package.resolved`
- Use specific version ranges
- Avoid deep dependency hierarchies

### Debugging Tips

#### 1. Verbose Output
```bash
swift package --verbose resolve
swift build --verbose
swift test --verbose
```

#### 2. Dependency Analysis
```bash
# Show all dependencies
swift package show-dependencies --format json | jq '.'

# Show specific package info
swift package describe --type json | jq '.dependencies[]'
```

#### 3. Build Analysis
```bash
# Show build timeline
swift build --verbose 2>&1 | grep "Compile"

# Show target dependencies
swift package dump-package | jq '.targets[]'
```

## Package Scripts

### Validation Script

Create `scripts/validate-packages.sh`:
```bash
#!/bin/bash
set -e

echo "ðŸ” Validating Swift Package Manager setup..."

# Check Package.swift syntax
swift package dump-package > /dev/null
echo "âœ… Package.swift syntax valid"

# Resolve dependencies
swift package resolve
echo "âœ… Dependencies resolved"

# Build all targets
swift build --configuration release
echo "âœ… Build successful"

# Run tests
swift test --configuration release
echo "âœ… Tests passed"

echo "ðŸŽ‰ Package validation complete!"
```

### Update Script

Create `scripts/update-packages.sh`:
```bash
#!/bin/bash
set -e

echo "ðŸ“¦ Updating Swift Package Manager dependencies..."

# Show current dependencies
echo "Current dependencies:"
swift package show-dependencies

# Update all dependencies
swift package update

# Show updated dependencies
echo "Updated dependencies:"
swift package show-dependencies

# Build with updated dependencies
swift build --configuration release

# Run tests to ensure compatibility
swift test --configuration release

echo "ðŸŽ‰ Dependencies updated successfully!"
```

### Make scripts executable:
```bash
chmod +x scripts/validate-packages.sh
chmod +x scripts/update-packages.sh
```

## Integration with Fastlane

Add to your `Fastfile`:
```ruby
desc "Validate Swift Package Manager setup"
lane :spm_validate do
  sh("./scripts/validate-packages.sh")
end

desc "Update Swift Package Manager dependencies"
lane :spm_update do
  sh("./scripts/update-packages.sh")
end
```

## Resources

### Official Documentation
- [Swift Package Manager Documentation](https://swift.org/package-manager/)
- [Package.swift Manifest API](https://github.com/apple/swift-package-manager/blob/main/Documentation/PackageDescription.md)
- [Swift Evolution Proposals](https://github.com/apple/swift-evolution)

### Community Resources
- [Swift Package Index](https://swiftpackageindex.com/)
- [Awesome Swift Packages](https://github.com/matteocrippa/awesome-swift)
- [Swift Forums - Package Manager](https://forums.swift.org/c/development/SwiftPM)

### Tools
- [swift-package-manager](https://github.com/apple/swift-package-manager)
- [Mint](https://github.com/yonaskolb/Mint) - Package installation tool
- [Marathon](https://github.com/JohnSundell/Marathon) - Package scripting tool

---

For questions or issues with package management, refer to the troubleshooting section or reach out to the development team.